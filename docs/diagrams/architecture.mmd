%%{ init: { "flowchart": { "curve": "stepBefore" } } }%%
flowchart LR
    %% KProvEngine V1 — Styled & Refactored

    %% Input
    Input@{ shape: lean-r, label: "Input Artifacts\n(files, images, notes)" }

    %% Core deterministic pipeline
    Normalize@{ shape: rect, label: "Normalize\n(deterministic · local-only)" }
    Parse@{ shape: rect, label: "Parse\n(format-aware · no inference)" }
    Extract@{ shape: rect, label: "Extract\n(structural extraction)" }
    Render@{ shape: rect, label: "Render\n(outputs)" }

    Evidence@{ shape: cyl, label: "Evidence Bundle\n(run directory)" }

    Input --> Normalize --> Parse --> Extract --> Render --> Evidence

    %% Optional adapters (explicitly non-authoritative)
    subgraph Adapters["Adapters (Optional · Non-authoritative)"]
        OCR@{ shape: lin-rect, label: "OCR Adapter\n(EasyOCR · Tesseract)" }
        LLM@{ shape: lin-rect, label: "LLM Adapter\n(Ollama · LangChain)" }
    end

    OCR -.-> Parse
    LLM -.-> Extract

    %% Evidence artifacts
    subgraph Artifacts["Evidence Artifacts (V1)"]
        Manifest@{ shape: doc, label: "manifest.json\nSHA-256 manifest" }
        Provenance@{ shape: doc, label: "provenance.json\nexecution metadata" }
        Toolchain@{ shape: doc, label: "toolchain.json\ntool/version disclosure" }
        HumanReview@{ shape: doc, label: "human_review.json\nPENDING allowed" }
        Hashes@{ shape: doc, label: "hashes.txt\ncontent hashes" }
        Attestation@{ shape: doc, label: "attestation.md\nhuman statement" }
        SBOM@{ shape: doc, label: "sbom.json\nCI-generated when available" }
    end

    Evidence --> Manifest
    Evidence --> Provenance
    Evidence --> Toolchain
    Evidence --> HumanReview
    Evidence --> Hashes
    Evidence --> Attestation
    Evidence --> SBOM

    %% Human in the loop (authority)
    Human@{ shape: rounded, label: "Human Reviewer" }
    Human --> HumanReview
    Human --> Attestation

    %% Styling
    classDef core fill:#e8f1ff,stroke:#4c6ef5,stroke-width:2px;
    classDef adapter fill:#f5f5f5,stroke:#999,stroke-dasharray:5 5;
    classDef evidence fill:#e6fcf5,stroke:#2f9e44;
    classDef human fill:#fff3bf,stroke:#f59f00,stroke-width:2px;

    class Normalize,Parse,Extract,Render core;
    class OCR,LLM adapter;
    class Evidence,Manifest,Provenance,Toolchain,HumanReview,Hashes,Attestation,SBOM evidence;
    class Human human;
